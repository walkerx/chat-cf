# Character Card V3 è§„èŒƒå®ç°çŠ¶æ€

## âœ… å·²å®Œå…¨å®ç°çš„åŠŸèƒ½

### åŸºç¡€å­—æ®µ
- âœ… `spec`, `spec_version`
- âœ… `name`, `description`, `personality`, `scenario`
- âœ… `first_mes`, `mes_example`, `alternate_greetings`
- âœ… `creator`, `creator_notes`, `character_version`
- âœ… `tags`, `extensions`
- âœ… `system_prompt`, `post_history_instructions`
- âœ… `nickname`
- âœ… `source`, `creation_date`, `modification_date`
- âœ… `group_only_greetings`
- âœ… `assets`
- âœ… `character_book` (Lorebook)

### Lorebook æ ¸å¿ƒåŠŸèƒ½
- âœ… `entries` - æ¡ç›®æ•°ç»„
- âœ… `name`, `description` - å…ƒæ•°æ®
- âœ… `scan_depth` - æ‰«ææ·±åº¦
- âœ… `extensions` - æ‰©å±•å­—æ®µ

### Lorebook Entry å­—æ®µ
- âœ… `keys` - å…³é”®è¯åŒ¹é…
- âœ… `secondary_keys` - æ¬¡è¦å…³é”®è¯
- âœ… `selective` - é€‰æ‹©æ€§æ¨¡å¼
- âœ… `content` - æ¡ç›®å†…å®¹
- âœ… `enabled` - å¯ç”¨/ç¦ç”¨
- âœ… `constant` - å¸¸é©»æ¡ç›®
- âœ… `insertion_order` - æ’å…¥é¡ºåº
- âœ… `position` - ä½ç½®ï¼ˆ`before_char`, `after_char`, `personality`, `scenario`ï¼‰
- âœ… `use_regex` - æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
- âœ… `case_sensitive` - å¤§å°å†™æ•æ„Ÿ
- âœ… `priority` - ä¼˜å…ˆçº§
- âœ… `id`, `comment`, `name` - å…ƒæ•°æ®
- âœ… `extensions` - æ‰©å±•å­—æ®µ

### è£…é¥°å™¨ (Decorators)
- âœ… `@@position` - ä½ç½®æ§åˆ¶
- âœ… `@@role` - è§’è‰²ç±»å‹ï¼ˆsystem/user/assistantï¼‰
- âœ… `@@depth` - æ·±åº¦æ§åˆ¶
- âœ… `@@scan_depth` - æ‰«ææ·±åº¦
- âœ… `@@activate_only_after` - å»¶è¿Ÿæ¿€æ´»
- âœ… `@@activate_only_every` - å‘¨æœŸæ€§æ¿€æ´»
- âœ… `@@additional_keys` - é¢å¤–å…³é”®è¯
- âœ… `@@exclude_keys` - æ’é™¤å…³é”®è¯
- âœ… `@@activate` - å¼ºåˆ¶æ¿€æ´»
- âœ… `@@dont_activate` - å¼ºåˆ¶ç¦ç”¨

### CBS å® (Curly Braced Syntax)
- âœ… `{{char}}` - è§’è‰²åç§°
- âœ… `{{user}}` - ç”¨æˆ·åç§°
- âœ… `{{random:A,B,C}}` - éšæœºé€‰æ‹©ï¼ˆæ”¯æŒè½¬ä¹‰é€—å·ï¼‰
- âœ… `{{pick:A,B,C}}` - ä¸€è‡´æ€§éšæœºé€‰æ‹©
- âœ… `{{roll:N}}` / `{{roll:dN}}` - æ·éª°å­
- âœ… `{{reverse:text}}` - åè½¬æ–‡æœ¬
- âœ… `{{// comment}}` - æ³¨é‡Š
- âœ… `{{hidden_key:text}}` - éšè—å…³é”®è¯
- âœ… `{{comment: text}}` - å†…è”æ³¨é‡Š

---

## âš ï¸ æœªå®ç°çš„åŠŸèƒ½

### 1. Lorebook é«˜çº§åŠŸèƒ½

#### `token_budget`
**è§„èŒƒ**: Token é¢„ç®—é™åˆ¶ï¼Œå½“ lorebook æ€» token è¶…è¿‡é¢„ç®—æ—¶ç§»é™¤ä½ä¼˜å…ˆçº§æ¡ç›®
**çŠ¶æ€**: âŒ æœªå®ç°
**ä¼˜å…ˆçº§**: ä¸­
**åŸå› **: éœ€è¦ token è®¡æ•°å™¨ï¼Œä¾èµ–å…·ä½“çš„ tokenizer

#### `recursive_scanning`
**è§„èŒƒ**: é€’å½’æ‰«æï¼Œlorebook æ¡ç›®çš„å†…å®¹ä¹Ÿå¯ä»¥è§¦å‘å…¶ä»–æ¡ç›®
**çŠ¶æ€**: âŒ æœªå®ç°
**ä¼˜å…ˆçº§**: ä½
**åŸå› **: å¤æ‚åº¦é«˜ï¼Œå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜

---

### 2. é«˜çº§è£…é¥°å™¨

#### `@@keep_activate_after_match`
**è§„èŒƒ**: ä¸€æ—¦åŒ¹é…è¿‡ï¼Œä¹‹åæ°¸è¿œä¿æŒæ¿€æ´»
**çŠ¶æ€**: âŒ æœªå®ç°
**ä¼˜å…ˆçº§**: ä½
**åŸå› **: éœ€è¦è·¨è¯·æ±‚çš„çŠ¶æ€ç®¡ç†

#### `@@dont_activate_after_match`
**è§„èŒƒ**: ä¸€æ—¦åŒ¹é…è¿‡ï¼Œä¹‹åæ°¸è¿œä¸å†æ¿€æ´»
**çŠ¶æ€**: âŒ æœªå®ç°
**ä¼˜å…ˆçº§**: ä½
**åŸå› **: éœ€è¦è·¨è¯·æ±‚çš„çŠ¶æ€ç®¡ç†

#### `@@instruct_depth`
**è§„èŒƒ**: åŸºäº token æ•°é‡çš„æ·±åº¦æ§åˆ¶ï¼ˆç”¨äº Instruction æ¨¡å¼ï¼‰
**çŠ¶æ€**: âŒ æœªå®ç°
**ä¼˜å…ˆçº§**: ä½
**åŸå› **: æˆ‘ä»¬ä½¿ç”¨ Chat APIï¼Œä¸æ˜¯ Instruction æ¨¡å¼

#### `@@reverse_depth`
**è§„èŒƒ**: åå‘æ·±åº¦è®¡æ•°
**çŠ¶æ€**: âŒ æœªå®ç°
**ä¼˜å…ˆçº§**: ä½
**åŸå› **: ä¸ `@@depth` ç›¸å…³ï¼ŒChat API ä¸éœ€è¦

#### `@@reverse_instruct_depth`
**è§„èŒƒ**: åå‘ token æ·±åº¦è®¡æ•°
**çŠ¶æ€**: âŒ æœªå®ç°
**ä¼˜å…ˆçº§**: ä½
**åŸå› **: Instruction æ¨¡å¼ä¸“ç”¨

#### `@@instruct_scan_depth`
**è§„èŒƒ**: åŸºäº token çš„æ‰«ææ·±åº¦
**çŠ¶æ€**: âŒ æœªå®ç°
**ä¼˜å…ˆçº§**: ä½
**åŸå› **: éœ€è¦ tokenizer

#### `@@is_greeting`
**è§„èŒƒ**: æ ¹æ®å½“å‰ä½¿ç”¨çš„ greeting ç´¢å¼•æ¿€æ´»
**çŠ¶æ€**: âŒ æœªå®ç°
**ä¼˜å…ˆçº§**: ä½
**åŸå› **: éœ€è¦è¿½è¸ªå½“å‰ greeting

#### `@@ignore_on_max_context`
**è§„èŒƒ**: ä¸Šä¸‹æ–‡è¾¾åˆ°æœ€å¤§å€¼æ—¶å¿½ç•¥æ­¤æ¡ç›®
**çŠ¶æ€**: âŒ æœªå®ç°
**ä¼˜å…ˆçº§**: ä¸­
**åŸå› **: éœ€è¦ token è®¡æ•°å’Œä¸Šä¸‹æ–‡ç®¡ç†

#### `@@is_user_icon`
**è§„èŒƒ**: æ ¹æ®ç”¨æˆ·å›¾æ ‡æ¿€æ´»
**çŠ¶æ€**: âŒ æœªå®ç°
**ä¼˜å…ˆçº§**: ä½
**åŸå› **: æˆ‘ä»¬ä¸æ”¯æŒç”¨æˆ·å›¾æ ‡ç³»ç»Ÿ

#### `@@disable_ui_prompt`
**è§„èŒƒ**: ç¦ç”¨ç‰¹å®šçš„ UI æç¤ºè¯ï¼ˆå¦‚ `post_history_instructions`ï¼‰
**çŠ¶æ€**: âŒ æœªå®ç°
**ä¼˜å…ˆçº§**: ä½
**åŸå› **: åŠŸèƒ½ç®€å•ä½†ä½¿ç”¨åœºæ™¯å°‘

---

### 3. è£…é¥°å™¨é«˜çº§ç‰¹æ€§

#### Fallback Decorators (@@@)
**è§„èŒƒ**: æ”¯æŒè£…é¥°å™¨å›é€€æœºåˆ¶
```
@@custom_decorator value
@@@standard_decorator value
```
**çŠ¶æ€**: âŒ æœªå®ç°
**ä¼˜å…ˆçº§**: ä½
**åŸå› **: å¤æ‚åº¦é«˜ï¼Œå®é™…ä½¿ç”¨å°‘

---

## ğŸ“Š å®ç°å®Œæˆåº¦ç»Ÿè®¡

### æ€»ä½“
- **æ ¸å¿ƒåŠŸèƒ½**: 100% âœ…
- **é«˜çº§åŠŸèƒ½**: 30% âš ï¸
- **è£…é¥°å™¨**: 60% âš ï¸
- **CBS å®**: 100% âœ…

### æŒ‰ä¼˜å…ˆçº§åˆ†ç±»

#### é«˜ä¼˜å…ˆçº§ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
- âœ… 100% å®Œæˆ
- æ‰€æœ‰åŸºç¡€å­—æ®µã€lorebookã€è£…é¥°å™¨ã€CBS å®

#### ä¸­ä¼˜å…ˆçº§ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰
- âš ï¸ 0% å®Œæˆ
- `token_budget` - Token é¢„ç®—ç®¡ç†
- `@@ignore_on_max_context` - ä¸Šä¸‹æ–‡é™åˆ¶

#### ä½ä¼˜å…ˆçº§ï¼ˆè¾¹ç¼˜åŠŸèƒ½ï¼‰
- âš ï¸ 0% å®Œæˆ
- çŠ¶æ€ç®¡ç†è£…é¥°å™¨ï¼ˆ`@@keep_activate_after_match` ç­‰ï¼‰
- Instruction æ¨¡å¼è£…é¥°å™¨ï¼ˆ`@@instruct_depth` ç­‰ï¼‰
- ç‰¹æ®ŠåŠŸèƒ½ï¼ˆ`@@is_greeting`, `@@is_user_icon` ç­‰ï¼‰
- Fallback decorators

---

## ğŸ¯ æ¨èå®ç°é¡ºåº

å¦‚æœè¦ç»§ç»­å®ç°ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºï¼š

### ç¬¬ä¸€é˜¶æ®µï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
1. âœ… **Token è®¡æ•°å™¨é›†æˆ**
   - é›†æˆ tiktoken æˆ–ç±»ä¼¼åº“
   - å®ç° `token_budget`
   - å®ç° `@@ignore_on_max_context`

### ç¬¬äºŒé˜¶æ®µï¼ˆä½ä¼˜å…ˆçº§ - å®ç”¨åŠŸèƒ½ï¼‰
2. âœ… **`@@disable_ui_prompt`**
   - ç®€å•å®ç°ï¼Œæ£€æŸ¥è£…é¥°å™¨å¹¶ç¦ç”¨å¯¹åº”å­—æ®µ

3. âœ… **`@@is_greeting`**
   - è¿½è¸ªå½“å‰ä½¿ç”¨çš„ greeting ç´¢å¼•

### ç¬¬ä¸‰é˜¶æ®µï¼ˆä½ä¼˜å…ˆçº§ - é«˜çº§åŠŸèƒ½ï¼‰
4. âœ… **çŠ¶æ€ç®¡ç†è£…é¥°å™¨**
   - `@@keep_activate_after_match`
   - `@@dont_activate_after_match`
   - éœ€è¦æ•°æ®åº“æˆ–ç¼“å­˜æ”¯æŒ

5. âœ… **Recursive scanning**
   - é€’å½’ lorebook æ‰«æ
   - éœ€è¦æ€§èƒ½ä¼˜åŒ–

### ç¬¬å››é˜¶æ®µï¼ˆå¯é€‰ï¼‰
6. âš ï¸ **Instruction æ¨¡å¼æ”¯æŒ**
   - `@@instruct_depth` ç­‰
   - ä»…åœ¨æ”¯æŒ Instruction API æ—¶éœ€è¦

7. âš ï¸ **Fallback decorators**
   - å¤æ‚åº¦é«˜ï¼Œæ”¶ç›Šä½

---

## ğŸ’¡ å»ºè®®

å¯¹äºå¤§å¤šæ•°ä½¿ç”¨åœºæ™¯ï¼Œ**å½“å‰å®ç°å·²ç»è¶³å¤Ÿ**ï¼š
- âœ… æ”¯æŒæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
- âœ… æ”¯æŒè‹é›ªå¿ç­‰å¤æ‚ Character Card
- âœ… ç¬¦åˆ V3 è§„èŒƒçš„ä¸»è¦éƒ¨åˆ†

æœªå®ç°çš„åŠŸèƒ½ä¸»è¦æ˜¯ï¼š
- éœ€è¦é¢å¤–ä¾èµ–ï¼ˆtokenizerï¼‰
- è¾¹ç¼˜ä½¿ç”¨åœºæ™¯
- ç‰¹å®šæ¨¡å¼ä¸“ç”¨ï¼ˆInstructionï¼‰
- è·¨è¯·æ±‚çŠ¶æ€ç®¡ç†

**å»ºè®®**: å…ˆä½¿ç”¨å½“å‰å®ç°ï¼Œæ ¹æ®å®é™…éœ€æ±‚å†å†³å®šæ˜¯å¦å®ç°é«˜çº§åŠŸèƒ½ã€‚
